<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="navbar">
        <h3>üí∞ Expense Tracker</h3>
        <span>
            ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userName">User</span> 
            <button onclick="logout()" class="btn-logout">‡∏≠‡∏≠‡∏Å</button>
        </span>
    </div>

    <div class="container">
        <div class="card" style="display: flex; gap: 20px; align-items: center; justify-content: space-around; flex-wrap: wrap;">
            <div style="text-align: center;">
                <h4>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h4>
                <h1 id="totalBalance" style="color: #333; font-size: 2.5em;">0 ‡∏ø</h1>
            </div>
            <div style="width: 250px; height: 250px;">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <div class="card input-section">
            <h3>üìù ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="form-row">
                <select id="type">
                    <option value="INCOME">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
                    <option value="EXPENSE">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
                </select>
                <input type="text" id="category" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß, ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á)">
                <input type="number" id="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
            </div>
            <input type="text" id="description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="width: 100%; margin-top: 10px;">
            <button id="btnSave" onclick="addTx()" style="margin-top: 10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>

        <div class="card list-section">
            <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <ul id="list"></ul>
        </div>
    </div>


   <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ---
        const token = localStorage.getItem('token');
        if(!token) window.location.href = '/login.html';

        document.getElementById('userName').innerText = localStorage.getItem('username') || 'User';

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏£‡∏≤‡∏ü (‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà)
        let myChart = null; 

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Toast Notification
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ---
        async function loadTx() {
            try {
                const res = await fetch('/api/transactions', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                const list = document.getElementById('list');
                const totalBalanceEl = document.getElementById('totalBalance');
                list.innerHTML = '';

                // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                let balance = 0;
                let expenseCategories = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà { '‡∏≠‡∏≤‡∏´‡∏≤‡∏£': 500, '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á': 200 }

                data.forEach(item => {
                    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                    if (item.type === 'INCOME') {
                        balance += item.amount;
                    } else {
                        balance -= item.amount;
                        
                        // 2. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ñ‡∏±‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ó‡∏≥‡∏Å‡∏£‡∏≤‡∏ü)
                        if (expenseCategories[item.category]) {
                            expenseCategories[item.category] += item.amount;
                        } else {
                            expenseCategories[item.category] = item.amount;
                        }
                    }

                    // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ HTML
                    const isIncome = item.type === 'INCOME';
                    const sign = isIncome ? '+' : '-';
                    const colorClass = isIncome ? 'income' : 'expense';
                    
                    list.innerHTML += `
                        <li class="tx-item ${colorClass}">
                            <span>
                                <b>${item.category}</b> <small>(${item.description || '-'})</small>
                            </span>
                            <span>${sign} ${item.amount} ‡∏ø</span>
                        </li>
                    `;
                });

                // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
                totalBalanceEl.innerText = balance.toLocaleString() + " ‡∏ø";
                if(balance < 0) totalBalanceEl.style.color = "red";
                else totalBalanceEl.style.color = "#28a745";

                // 5. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà
                renderChart(expenseCategories);

            } catch (err) {
                console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
            }
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü (Chart.js) ---
        function renderChart(categories) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
            const labels = Object.keys(categories);
            const data = Object.values(categories);

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
            if (myChart) {
                myChart.destroy();
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏î
            if (labels.length === 0) {
                return; 
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° (Donut Chart)
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' } // ‡πÄ‡∏≠‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
                    }
                }
            });
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        async function addTx() {
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;
            const btn = document.getElementById('btnSave');

            if(!amount || !category) {
                return Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö' });
            }

            btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    },
                    body: JSON.stringify({ type, amount, category, description })
                });

                if(res.ok) {
                    Toast.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
                    document.getElementById('amount').value = '';
                    document.getElementById('category').value = '';
                    document.getElementById('description').value = '';
                    
                    // ‡∏û‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡πá‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥!
                    loadTx(); 
                } else {
                    Swal.fire({ icon: 'error', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
                }
            } catch (err) {
                console.error(err);
            } finally {
                btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                btn.disabled = false;
            }
        }

        function logout() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            });
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        loadTx();

        // --- Real-time Socket.io ---
        const socket = io();
        socket.on('new_transaction', (newTx) => {
            loadTx(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡πá‡∏Ç‡∏¢‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
            Toast.fire({
                icon: 'info',
                title: `‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà: ${newTx.category}`
            });
        });
    </script>
</body>
</html>