<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <link rel="stylesheet" href="style.css">
</head>
<script src="/socket.io/socket.io.js"></script>
<body>
    <div class="navbar">
        <h3>üí∞ Expense Tracker</h3>
        <span>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userName">User</span> <button onclick="logout()" class="btn-logout">‡∏≠‡∏≠‡∏Å</button></span>
    </div>

    <div class="container">
        <div class="card input-section">
            <h3>üìù ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="form-row">
                <select id="type">
                    <option value="INCOME">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
                    <option value="EXPENSE">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
                </select>
                <input type="text" id="category" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)">
                <input type="number" id="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
            </div>
            <input type="text" id="description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="width: 100%; margin-top: 10px;">
            <button onclick="addTx()" style="margin-top: 10px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>

        <div class="card list-section">
            <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <ul id="list"></ul>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if(!token) window.location.href = '/login.html'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Token ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Login

        document.getElementById('userName').innerText = localStorage.getItem('username') || 'User';

        async function loadTx() {
            const res = await fetch('/api/transactions', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            const list = document.getElementById('list');
            list.innerHTML = '';

            data.forEach(item => {
                const isIncome = item.type === 'INCOME';
                const sign = isIncome ? '+' : '-';
                const colorClass = isIncome ? 'income' : 'expense';
                
                list.innerHTML += `
                    <li class="tx-item ${colorClass}">
                        <span>
                            <b>${item.category}</b> <small>(${item.description || '-'})</small>
                        </span>
                        <span>${sign} ${item.amount} ‡∏ø</span>
                    </li>
                `;
            });
        }

        async function addTx() {
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;

            if(!amount || !category) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ô‡∏∞');

            await fetch('/api/transactions', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token 
                },
                body: JSON.stringify({ type, amount, category, description })
            });

            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
            document.getElementById('amount').value = '';
            document.getElementById('category').value = '';
            document.getElementById('description').value = '';
            loadTx();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        loadTx(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        // ... (‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ...

// 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Socket
const socket = io();

// 2. ‡∏Ñ‡∏≠‡∏¢‡∏ü‡∏±‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ä‡∏∑‡πà‡∏≠ 'new_transaction'
socket.on('new_transaction', (newTx) => {
    console.log("‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤!", newTx);

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á User ‡πÄ‡∏£‡∏≤‡πÑ‡∏´‡∏°? (‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å Room ‡πÅ‡∏ï‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô)
    // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ" ‡πÄ‡∏•‡∏¢
    loadTx(); 

    // (‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô) ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ
    alert(`‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà: ${newTx.category} (${newTx.amount} ‡∏ö‡∏≤‡∏ó)`);
});
    </script>
</body>
</html>